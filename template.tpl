___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "BG & Pixel",
  "categories": [
    "ADVERTISING",
    "CONVERSIONS",
    "REMARKETING"
  ],
  
  "description": "This tag helps you to send event data to Facebook via conventional pixel and via Conversions API.",
  "containerContexts": [
    "WEB"
  ]
}

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "BG \u0026 Pixel",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "setup",
    "displayName": "Event",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "event_name",
        "displayName": "Event name",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "AddPaymentInfo",
            "displayValue": "AddPaymentInfo"
          },
          {
            "value": "AddToCart",
            "displayValue": "AddToCart"
          },
          {
            "value": "AddToWishlist",
            "displayValue": "AddToWishlist"
          },
          {
            "value": "CompleteRegistration",
            "displayValue": "CompleteRegistration"
          },
          {
            "value": "Contact",
            "displayValue": "Contact"
          },
          {
            "value": "CustomizeProduct",
            "displayValue": "CustomizeProduct"
          },
          {
            "value": "Donate",
            "displayValue": "Donate"
          },
          {
            "value": "FindLocation",
            "displayValue": "FindLocation"
          },
          {
            "value": "InitiateCheckout",
            "displayValue": "InitiateCheckout"
          },
          {
            "value": "Lead",
            "displayValue": "Lead"
          },
          {
            "value": "PageView",
            "displayValue": "PageView"
          },
          {
            "value": "Purchase",
            "displayValue": "Purchase"
          },
          {
            "value": "Schedule",
            "displayValue": "Schedule"
          },
          {
            "value": "Search",
            "displayValue": "Search"
          },
          {
            "value": "StartTrial",
            "displayValue": "StartTrial"
          },
          {
            "value": "SubmitApplication",
            "displayValue": "SubmitApplication"
          },
          {
            "value": "Subscribe",
            "displayValue": "Subscribe"
          },
          {
            "value": "ViewContent",
            "displayValue": "ViewContent"
          }
        ],
        "simpleValueType": true,
        "help": "For more info about the events, please check \u003ca href\u003d\"https://developers.facebook.com/docs/facebook-pixel/reference/\"\u003eFacebook\u0027s Reference Guide\u003c/a\u003e.",
        "alwaysInSummary": true,
        "subParams": [],
        "defaultValue": "PageView"
      },
      {
        "type": "RADIO",
        "name": "fireMethod",
        "displayName": "Fire method",
        "radioItems": [
          {
            "value": "onlyPixel",
            "displayValue": "Only Facebook pixel for web"
          },
          {
            "value": "onlyCapi",
            "displayValue": "Only Conversions API"
          },
          {
            "value": "both",
            "displayValue": "Both Facebook pixel for web \u0026 Conversions API"
          }
        ],
        "simpleValueType": true,
        "help": "Choose if you want to send this event only through Facebook pixel (web), through Conversions API (server) or both.",
        "defaultValue": "both"
      },
      {
        "type": "TEXT",
        "name": "pixelId",
        "displayName": "Pixel ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Add the pixel IDs which you want to fire this event for. This field applies for the pixel (web) events and server events when set up through \u003ca href\u003d\"https://www.adsmurai.com/en/product/serverless-tracking\"\u003eAdsmurai Serverless Tracking\u003c/a\u003e. If you use a custom server. the pixel IDs to be fired for this event when using Conversions API must be set server-side.",
        "alwaysInSummary": false,
        "notSetText": "Please, input pixel ID",
        "enablingConditions": [
          {
            "paramName": "fireMethod",
            "paramValue": "onlyPixel",
            "type": "EQUALS"
          },
          {
            "paramName": "fireMethod",
            "paramValue": "both",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "serverGtmUrl",
        "displayName": "Your server\u0027s URL",
        "simpleValueType": true,
        "valueHint": "https://gtm.yourwebsite.com",
        "enablingConditions": [
          {
            "paramName": "fireMethod",
            "paramValue": "onlyCapi",
            "type": "EQUALS"
          },
          {
            "paramName": "fireMethod",
            "paramValue": "both",
            "type": "EQUALS"
          }
        ],
        "alwaysInSummary": true,
        "help": "The URL of the tag management server you are using for Conversions API.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customData",
    "displayName": "Data parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "content_name",
        "displayName": "Content name (content_name)",
        "simpleValueType": true,
        "help": "The name of the page or product associated with the event.\u003cbr\u003e\u003cbr\u003eExample: \u0027lettuce\u0027."
      },
      {
        "type": "TEXT",
        "name": "content_category",
        "displayName": "Content category (content_category)",
        "simpleValueType": true,
        "help": "The category of the content associated with the event.\u003cbr\u003e\u003cbr\u003eExample: \u0027grocery\u0027."
      },
      {
        "type": "SELECT",
        "name": "content_type",
        "displayName": "Content type (content_type)",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "product",
            "displayValue": "product"
          },
          {
            "value": "product_group",
            "displayValue": "product_group"
          },
          {
            "value": "home_listing",
            "displayValue": "home_listing"
          },
          {
            "value": "hotel",
            "displayValue": "hotel"
          },
          {
            "value": "flight",
            "displayValue": "flight"
          },
          {
            "value": "destination",
            "displayValue": "destination"
          },
          {
            "value": "vehicle",
            "displayValue": "vehicle"
          }
        ],
        "simpleValueType": true,
        "help": "It should be set to \u0027product\u0027 or \u0027product_group\u0027:\u003cul\u003e\u003cli\u003eUse \u0027product\u0027, if the keys you send represent products. Sent keys could be content_ids or contents.\u003c/li\u003e\u003cli\u003eUse \u0027product_group\u0027, if the keys you send in content_ids represent product groups. Product groups are used to distinguish products that are identical but have variations such as color, material, size or pattern.\u003c/li\u003e\u003c/ul\u003e",
        "notSetText": "Not set"
      },
      {
        "type": "TEXT",
        "name": "content_ids",
        "displayName": "Content IDs (content_ids)",
        "simpleValueType": true,
        "help": "The content IDs associated with the event, such as product SKUs for items in an AddToCart event: [\u0027ABC123\u0027, \u0027XYZ789\u0027].\u003cbr\u003e\u003cbr\u003eIf content_type is a product, then your content IDs must be an array with a single string value. Otherwise, this array can contain any number of string values."
      },
      {
        "type": "TEXT",
        "name": "contents",
        "displayName": "Contents (contents)",
        "simpleValueType": true,
        "help": "A list of JSON objects that contain the product IDs associated with the event plus information about the products. id, quantity, and item_price are available fields.\u003cbr\u003e\u003cbr\u003eExample: [{\u0027id\u0027:\u0027ABC123\u0027,\u0027quantity\u0027 :2,\u0027item_price\u0027:5.99}, {\u0027id\u0027:\u0027XYZ789\u0027,\u0027quantity\u0027:2, \u0027item_price\u0027:9.99, \u0027delivery_category\u0027: \u0027in_store\u0027}]\u003cbr\u003e\u003cbr\u003eYou can choose to fill either this field or content_ids. If you fill both, this tag will use this field and discard content_ids."
      },
      {
        "type": "TEXT",
        "name": "value",
        "displayName": "Value (value)",
        "simpleValueType": true,
        "help": "\u003cb\u003eRequired for Purchase events.\u003c/b\u003e\u003cbr\u003eA numeric value associated with this event. This could be a monetary value or a value in some other metric.\u003cbr\u003e\u003cbr\u003eExample: 142.54."
      },
      {
        "type": "TEXT",
        "name": "currency",
        "displayName": "Currency (currency)",
        "simpleValueType": true,
        "help": "\u003cb\u003eRequired for Purchase events.\u003c/b\u003e\u003cbr\u003eCurrency must be a valid \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_4217?fbclid\u003dIwAR1WMqA7X8FtKGZY3A1DDBvf972gpNQ3oKzGg8tBhSCSbt_xc3HdLIxyW0A\"\u003eISO 4217 three digit currency code\u003c/a\u003e.\u003cbr\u003e\u003cbr\u003eExample: \u0027USD\u0027."
      },
      {
        "type": "TEXT",
        "name": "num_items",
        "displayName": "No of items (num_items)",
        "simpleValueType": true,
        "help": "Use only with InitiateCheckout events. The number of items that a user tries to buy during checkout.\u003cbr\u003e\u003cbr\u003eExample: \u00274\u0027."
      },
      {
        "type": "TEXT",
        "name": "search_string",
        "displayName": "Search string (search_string)",
        "simpleValueType": true,
        "help": "Use only with Search events. A search query made by a user.\u003cbr\u003e\u003cbr\u003eExample: \u0027lettuce\u0027."
      },
      {
        "type": "TEXT",
        "name": "status",
        "displayName": "Status (status)",
        "simpleValueType": true,
        "help": "Use only with CompleteRegistration events. The status of the registration event.\u003cbr\u003e\u003cbr\u003eExample: \u0027registered\u0027."
      },
      {
        "type": "TEXT",
        "name": "predicted_ltv",
        "displayName": "Predicted LTV (predicted_ltv)",
        "simpleValueType": true,
        "help": "Predicted LTV (predicted_ltv)"
      }
    ],
    "help": "Parameters with extra data that you can send along your events. See \u003ca href\u003d\"https://developers.facebook.com/docs/facebook-pixel/reference/\"\u003ethis guide\u003c/a\u003e to know which parameters are accepted for each standard event. All fields are optional, except currency and value when event is Purchase."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

if (!data.event_name) {
	data.gtmOnSuccess();
	return;
}

const copyFromWindow = require("copyFromWindow");
const getType = require("getType");
const injectScript = require("injectScript");
const getCookieValues = require("getCookieValues");
const setCookie = require("setCookie");
const getTimestampMillis = require("getTimestampMillis");
const log = require("logToConsole");

const event_id = data.fireMethod === "both" ? getTimestampMillis().toString() : undefined;

if (data.fireMethod === "onlyPixel" || data.fireMethod === "both") {
	firePixelEvent();
}

if (data.fireMethod === "onlyCapi" || data.fireMethod === "both") {
	fireCapiEvent();
}

function firePixelEvent() {
	const setInWindow = require("setInWindow");

	const fbq = getFbq();

	// Build the fbq() command arguments
	const command = "trackSingle";
	const eventName = data.event_name;

	const initIds = copyFromWindow("_fbq_gtm_ids") || [];
    if(initIds.indexOf(data.pixelId) === -1){
        fbq("init", data.pixelId);
        initIds.push(data.pixelId);
        setInWindow("_fbq_gtm_ids", initIds, true);
    }
    fbq(command, data.pixelId, eventName, getPixelEventParameters());

	injectScript("https://connect.facebook.net/en_US/fbevents.js", handlePixelSuccessfullyFired, handlePixelUnsuccessfullyFired, "fbPixel");

	function getFbq() {
		const callInWindow = require("callInWindow");
		const aliasInWindow = require("aliasInWindow");
		const createQueue = require("createQueue");

		let fbq = copyFromWindow("fbq");
		log("fbq", fbq);
		if (fbq) return fbq;

		// Initialize the 'fbq' global method to either use fbq.callMethod or fbq.queue
		setInWindow("fbq", function () {
			const callMethod = copyFromWindow("fbq.callMethod.apply");
			log("callMethod", callMethod);
			if (callMethod) {
				callInWindow("fbq.callMethod.apply", null, arguments);
			} else {
				callInWindow("fbq.queue.push", arguments);
			}
		});

		aliasInWindow("_fbq", "fbq");
		createQueue("fbq.queue");
		return copyFromWindow("fbq");
	}

	function getPixelEventParameters() {
		let eventParameters = {};

		const fieldsToAdd = ["content_name", "content_category", "content_type", "content_ids", "contents", "value", "currency", "num_items", "search_string", "status", "predicted_ltv"];

		fieldsToAdd.forEach((field) => {
			if (getType(data[field]) === "undefined" || getType(data[field]) === "function") return;
            eventParameters[field] = data[field];
		});

		return eventParameters;
	}

	function handlePixelSuccessfullyFired() {
		if (data.fireMethod === "onlyPixel") {
			data.gtmOnSuccess();
		}
	}

	function handlePixelUnsuccessfullyFired() {
		if (data.fireMethod === "onlyPixel") {
			data.gtmOnFailure();
		}
	}
}

function fireCapiEvent() {
	const sendPixel = require("sendPixel");
	const getUrl = require("getUrl");
	const Math = require("Math");
    const bgServerUrl = data.serverGtmUrl;
  
	
	const url = bgServerUrl + "?" + getRequestQueryParametersForOwnServer();
    log('in url',url);
    
	sendPixel(url, handleCapiSuccessfullyFired, handleCapiUnsuccessfullyFired);

	function getRequestQueryParametersForOwnServer() {
		let url = "";

		const manuallyFilledProps = ["event_name", "em", "ph", "ge", "db", "ln", "fn", "ct", "st", "zp", "country", "external_id", "subscription_id", "lead_id", "fb_login_id", "value", "currency", "content_name", "content_category", "content_ids", "contents", "content_type", "order_id", "customProperties", "num_items", "predicted_ltv", "search_string", "status", "delivery_category", "opt_out", "event_id", "action_source", "data_processing_options", "data_processing_options_country", "data_processing_options_state"];

		const automaticallyFilledProps = ["fbp", "fbc", "event_source_url", "event_time","clickId"];

		const propsToHash = ["em", "ph", "ge", "db", "ln", "fn", "ct", "st", "zp", "country", "external_id"];

		manuallyFilledProps.forEach((prop) => {
			if (getType(data[prop]) === "undefined" || getType(data[prop]) === "function") return;

			let value;

			switch (prop) {
				case "event_name":
					value = data.event_name === "customEvent" ? data.customEventName : data.event_name;
					break;
				case "data_processing_options":
					value = data[prop] === "emptyArray" ? [] : ["LDU"];
					break;
				case "event_id":
					value = data.event_id === "autogenerate" ? event_id : data.ownEventId;
					break;
				default:
					value = data[prop];
			}

			if (data.hashData && propsToHash.some((propToHash) => prop === propToHash)) {
				// Avoid hashing external_id if user didn't ask to
				if (prop !== "external_id" || data.hashExternalId) {
					value = hash(data[prop]);
				}
			}

			url += prop + "=" + encodeProperty(value) + "&";
		});

		automaticallyFilledProps.forEach((prop) => {
			let value;

			switch (prop) {
				case "fbc":
					value = setOrGetFbcCookie();
					break;
                case "clickId":
					value = setOrGetBGCookie();
					break;
				case "fbp":
					if (getCookieValues("_fbp").length > 0) {
						value = getCookieValues("_fbp")[0];
					} else {
						value = generateFbpCookie();
					}
					break;
				case "event_source_url":
					value = getUrl();
					break;
				case "event_time":
					value = Math.floor(getTimestampMillis() / 1000);
			}

			url += prop + "=" + encodeProperty(value) + "&";
		});

		return url.slice(0, -1); // slice() removes the last &
	}

	function hash(valueToHash) {
		const makeString = require("makeString");

		const sha256 = copyFromWindow("sha256");

		if (!sha256) return valueToHash;

		switch (getType(valueToHash)) {
			case "undefined":
			case "null":
			case "object":
			case "function":
			case "boolean":
				return valueToHash;
			case "string":
				return sha256(valueToHash.toLowerCase().trim());
			case "number":
				return sha256(makeString(valueToHash));
			case "array":
				return valueToHash.map((value) => hash(value));
			default:
				return sha256(valueToHash);
		}
	}

	function encodeProperty(prop) {
		const encodeUriComponent = require("encodeUriComponent");
		const JSON = require("JSON");

		switch (getType(prop)) {
			case "function":
			case "undefined":
			case "null":
				return null;
			default:
				return encodeUriComponent(JSON.stringify(prop));
		}
	}
    function setOrGetBGCookie() {
		const getQueryParameters = require("getQueryParameters");
		let value;
		if (getQueryParameters("clickId", false)) {
            value = getQueryParameters("clickId");
            setCookie('_bgclick',value, { domain: "auto"});
		} else if (getCookieValues("_bgclick").length > 0 && getCookieValues("_bgclick")[0] !== "") {
			value = getCookieValues("_bgclick")[0];
		} else {
			value = undefined;
		}
		return value;
	}

	function setOrGetFbcCookie() {
		// See https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/fbp-and-fbc/#fbc
		const getQueryParameters = require("getQueryParameters");

		let value;

		if (getQueryParameters("fbclid", false)) {
			value = "fb.1." + getTimestampMillis() + "." + getQueryParameters("fbclid");
			// If there's no Facebook pixel on the page that will
			// create or update the _fbc cookie automatically, do it manually
			let fbq = copyFromWindow("fbq");
			if (!fbq) setCookie("_fbc", value, { domain: "auto", "max-age": 7776000, path: "/" });
		} else if (getCookieValues("_fbc").length > 0 && getCookieValues("_fbc")[0] !== "") {
			// If there's an _fbc cookie and is not an empty string
			value = getCookieValues("_fbc")[0];
		} else {
			value = undefined;
		}

		return value;
	}

	function generateFbpCookie() {
		// If there's no fbp cookie, we build it
		// See https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/fbp-and-fbc#fbp
		const generateRandom = require("generateRandom");
		const cookieValue = "fb.1." + getTimestampMillis() + "." + generateRandom(1000000000, 9999999999);

		setCookie("_fbp", cookieValue, { domain: "auto", "max-age": 7776000, path: "/" }); // sets the cookie so we have the same value in the future

		return cookieValue;
	}

	function resetCookiesExpiration() {
		// Facebook pixel's code resets expiration date of _fbc and _fbp cookies to 90 days on every event
		// If user is sending only through CAPI, thus not sending event through pixel,
		// we update the expiration date manually here
		if (getCookieValues("_fbc").length > 0 && getCookieValues("_fbc")[0] !== "") {
			const fbcValue = getCookieValues("_fbc")[0];
			setCookie("_fbc", fbcValue, { domain: "auto", "max-age": 7776000, path: "/" });
		}

		if (getCookieValues("_fbp").length > 0 && getCookieValues("_fbp")[0] !== "") {
			const fbpValue = getCookieValues("_fbp")[0];
			setCookie("_fbp", fbpValue, { domain: "auto", "max-age": 7776000, path: "/" });
		}
	}
    

	function handleCapiSuccessfullyFired() {
		if (data.fireMethod === "onlyCapi") resetCookiesExpiration();
		data.gtmOnSuccess();
	}

	function handleCapiUnsuccessfullyFired() {
		if (data.fireMethod === "onlyCapi") resetCookiesExpiration();
        log('in fail');
		data.gtmOnFailure();
	}
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.callMethod.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq_gtm_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://connect.facebook.net/en_US/fbevents.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              },
              {
                "type": 1,
                "string": "_bgclick"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbp"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbc"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_bgclick"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2023/8/28 17:00:01


